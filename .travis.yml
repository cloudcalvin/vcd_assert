sudo: required

language: generic

services:
  - docker

before_script:
  - docker run --name runner -t -d pleroux0/centos7-devel
  - docker exec runner git clone -b "${TRAVIS_BRANCH}" --recurse-submodules --depth=1 "https://github.com/${TRAVIS_REPO_SLUG}.git" "repo"
  - docker exec runner mkdir "repo/travis-build"
  - docker exec runner conan remote add pleroux0 "https://api.bintray.com/conan/pleroux0/pleroux0"

matrix:
  include:
    # CentOS Release build
    - script:
        - docker exec runner scl enable devtoolset-7 -- bash -c "cd repo/travis-build && conan install .. --build=missing -s build_type=Release"
        - docker exec runner scl enable devtoolset-7 -- bash -c "cd repo/travis-build && conan build .."

    # Coverage report
    - env:
      - CXXFLAGS="--coverage"
      script:
      - docker exec runner scl enable devtoolset-7 -- bash -c "cd repo/travis-build && conan install .. --build=missing -s build_type=Debug"
      - docker exec runner scl enable devtoolset-7 -- bash -c "cd repo/travis-build && conan build .."
      - docker exec runner scl enable devtoolset-7 -- bash -c "cd repo/travis-build && coveralls --gcov-options '\-lp'"

    # Valgrind
    - script:
      - docker exec runner scl enable devtoolset-7 -- bash -c "cd repo/travis-build && conan install .. --build=missing -s build_type=Debug"
      - docker exec runner scl enable devtoolset-7 -- bash -c "cd repo/travis-build && conan build .."
      - docker exec runner scl enable devtoolset-7 -- bash -c "cd repo/travis-build && ctest -T memcheck"
      - docker exec runner bash -c "cat repo/travis-build/Testing/Temporary/MemoryChecker.*.log"
      - docker exec runner bash -c "if [ -s repo/travis-build/Testing/Temporary/MemoryChecker.*.log ]; then false; fi"
